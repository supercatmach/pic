<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"></script>

</head>
<body>
<div id="app">
  <h1 style="text-align:center;">è¶…ç§‘å­¸éº»å°‡ç¤¾</h1>
  <div style="text-align:center; margin-bottom: 10px;">
    <span>ç·šä¸Šç¸½äººæ•¸ï¼š{{ totalPlayers }}</span> |
    <span>æˆ¿é–“æ•¸ï¼š{{ totalRooms }}</span>
  </div>
  <div class="table-area">
    <div class="room" v-for="(room, roomId) in rooms" :key="roomId">
      <!-- ğŸ debug log æ¯å¼µæ¡Œå­çš„å…§å®¹ -->
      {{ console.log("ğŸ“¦ roomId:", roomId, room) }}

      <!-- ç”¨ room.players è¿´åœˆï¼Œé †åºç…§ players -->
<template v-for="(playerId, idx) in room.players" :key="playerId">
  <div class="player" :class="'player' + idx">
    <img :src="'head/cv' + getCheByPlayerId(playerId, room.playerpic) + '.png'" />
    <!-- å°è©±æ³¡æ³¡ -->
    <div
      class="outcard-bubble"
      v-if="hallOutcards[roomId] && hallOutcards[roomId][playerId]"
    >
      {{ hallOutcards[roomId][playerId] }}
    </div>
  </div>
</template>

      <!-- æ¡Œå­åœ– -->
      <div class="table">
        <img src="backg/tablesmoll.png" />
      </div>
    </div>
  </div>
</div>

<style>
    body {
      font-family: sans-serif;
      background: #eee;
    }
.table-area {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  justify-content: center;
}

.room {
  position: relative;
  width: 250px;
  height: 250px;
  background: #f0f0f0;
  border-radius: 12px;
  overflow: hidden;
}

.table {
  position: absolute;
  top: 50%;
  left: 50%;
  z-index: 1;
  transform: translate(-50%, -50%);
}

.player {
  position: absolute;
  z-index: 2; /* âœ… è®“ç©å®¶åœ–åƒåœ¨æ¡Œå­ä¸‹é¢å°±èª¿æˆ 0 */
}

.player0 {
  top: 80%;
  left: 50%;
  transform: translate(-50%, -50%);
}
.player1 {
  top: 50%;
  left: 80%;
  transform: translate(-50%, -50%);
}
.player2 {
  top: 20%;
  left: 50%;
  transform: translate(-50%, -50%);
}
.player3 {
  top: 50%;
  left: 20%;
  transform: translate(-50%, -50%);
}

.player img {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 2px solid #555;
  background: white;
}

.outcard-bubble {
  position: absolute;
  top: -10px;
  right: -10px;
  background-color: #fffbe6;
  border: 1px solid #ccc;
  border-radius: 10px;
  font-size: 28px;
  padding: 2px 6px;
  z-index: 10;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  white-space: nowrap;
}

    @keyframes fadeout {
      0% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; }
    }
</style>
    <script>
const { createApp } = Vue;
createApp({
  data() {
    return {
      socket: null,
      rooms: {},
      hallOutcards: {},       // å‡ºç‰Œé¡¯ç¤ºæš«å­˜ { [roomId]: { [playerId]: "ğŸ€‡" } }
      currentOutcardPlayer: null, // { roomId, playerId }ï¼Œç´€éŒ„ç›®å‰é¡¯ç¤ºèª°çš„ç‰Œæ³¡æ³¡
      outcardTimeout: null,       // å®šæ™‚å™¨ID
    totalPlayers: 0,
    totalRooms: 0
    };
  },
  mounted() {
    this.socket = io("https://mj-5x4w.onrender.com");
    this.socket.emit("getRooms");

    // æ›´æ–°æˆ¿é–“è³‡æ–™
    this.socket.on("updateRooms", (rooms) => {
      this.rooms = rooms;
    });

    // ç©å®¶æ‰“ç‰Œ
    this.socket.on("outcardtohall", (outcard) => {
      const roomId = outcard[0];
      const [playerId, cardNum] = JSON.parse(outcard[1]);
      console.log("outcardtohall", outcard);

      // è½‰æ›ç‰Œæ–‡å­—ç‚ºå°æ‡‰ç¬¦è™Ÿ
      const cardSymbol = this.cardToUnicode(cardNum);

      if (!this.hallOutcards[roomId]) this.hallOutcards[roomId] = {};

      // å…ˆæ¸…æ‰ä¸Šä¸€å€‹ç©å®¶çš„ç‰Œæ³¡æ³¡ï¼ˆå¦‚æœå­˜åœ¨ä¸”ä¸ç­‰æ–¼ç¾åœ¨é€™ä½ï¼‰
      if (this.currentOutcardPlayer) {
        const { roomId: oldRoomId, playerId: oldPlayerId } = this.currentOutcardPlayer;
        if (oldRoomId !== roomId || oldPlayerId !== playerId) {
          if (this.hallOutcards[oldRoomId]) {
            delete this.hallOutcards[oldRoomId][oldPlayerId];
          }
        }
      }

      // æ¸…é™¤å‰ä¸€æ¬¡timeout
      if (this.outcardTimeout) clearTimeout(this.outcardTimeout);

      // é¡¯ç¤ºæ–°ç©å®¶å‡ºç‰Œæ³¡æ³¡
      this.hallOutcards[roomId][playerId] = cardSymbol;
      this.currentOutcardPlayer = { roomId, playerId };

      // 3ç§’å¾Œéš±è—æ³¡æ³¡
      this.outcardTimeout = setTimeout(() => {
        if (this.hallOutcards[roomId]) {
          delete this.hallOutcards[roomId][playerId];
        }
        this.currentOutcardPlayer = null;
        this.outcardTimeout = null;
      }, 3000);
    });
this.socket.on("updateStats", (stats) => {
  this.totalPlayers = stats.totalPlayers;
  this.totalRooms = stats.totalRooms;
});

this.socket.on("canephtohall", (payload) => {
  const roomId = payload[0];
  const [playerId, , dwo] = JSON.parse(payload[1]);

  if (!this.hallOutcards[roomId]) this.hallOutcards[roomId] = {};

  // æ¸…é™¤ä¸Šä¸€å€‹ç©å®¶æ³¡æ³¡ï¼ˆå¦‚æœè·Ÿæ–°ç©å®¶ä¸åŒï¼‰
  if (this.currentOutcardPlayer) {
    const { roomId: oldRoomId, playerId: oldPlayerId } = this.currentOutcardPlayer;
    if (oldRoomId !== roomId || oldPlayerId !== playerId) {
      if (this.hallOutcards[oldRoomId]) {
        delete this.hallOutcards[oldRoomId][oldPlayerId];
      }
    }
  }

  const actionMap = {
    eat: "åƒ",
    pon: "ç¢°",
    gun: "æ§“",
    win: "èƒ¡",
    mywin: "è‡ªæ‘¸",
  };

  this.hallOutcards[roomId][playerId] = actionMap[dwo] || dwo;
  this.currentOutcardPlayer = { roomId, playerId };
});

    // ğŸ‘‰ æ¸¬è©¦å‡è³‡æ–™ç”¨
    /*
    this.rooms = {
      A001: {
        playerpic: [
          { che: "01", playerId: "a1" },
          { che: "02", playerId: "a2" },
          null,
          { che: "03", playerId: "a4" }
        ]
      }
    };

    setTimeout(() => {
      this.socket.emit("outcardtohall", [
        "A001",
        JSON.stringify(["a1", 1])
      ]);
    }, 1000);

    setTimeout(() => {
      this.socket.emit("outcardtohall", [
        "A001",
        JSON.stringify(["a2", 10])
      ]);
    }, 2000);
    */
  },
  methods: {
  getCheByPlayerId(playerId, playerpic) {
    if (!playerpic || !Array.isArray(playerpic)) return "default";
    const pic = playerpic.find(p => p && p.playerId === playerId);
    return pic ? pic.che : "default"; // æ‰¾ä¸åˆ°å›å‚³é è¨­åœ–ç‰‡ä»£è™Ÿ
  },
    // éº»å°‡ç‰Œæ•¸å­—è½‰ Unicode å­—ç¬¦
    cardToUnicode(num) {
      if (num >= 1 && num <= 9) return String.fromCodePoint(0x1F007 + (num - 1)); // ğŸ€‡~ğŸ€ è¬
      if (num >= 10 && num <= 18) return String.fromCodePoint(0x1F019 + (num - 10)); // ğŸ€™~ğŸ€¡ ç­’
      if (num >= 19 && num <= 27) return String.fromCodePoint(0x1F010 + (num - 19)); // ğŸ€~ğŸ€˜ æ¢
      const honors = {
        28: 0x1F000, // æ±
        29: 0x1F001, // å—
        30: 0x1F002, // è¥¿
        31: 0x1F003, // åŒ—
        32: 0x1F004, // ä¸­
        33: 0x1F005, // ç™¼
        34: 0x1F006  // ç™½
      };
      return String.fromCodePoint(honors[num] || 0x2753); // ï¼Ÿ(æœªçŸ¥)
    }
  }
}).mount("#app");

    </script>
</body>
</html>